{# templates/index.html #}
{% extends "layout.html" %}

{# ── Page metadata ────────────────────────────────────────── #}
{% block title %}Next Stop{% endblock %}
{% block page  %}Next Stop{% endblock %}

{{ super() }}

{# ── Main Page Content ────────────────────────────────────── #}
{% block content %}
<div class="container">

  <div class="row">
    <div class="col s12">
      <div class="card">
        <div class="card-content">
          <span class="card-title center-align">Available Routes</span>

          <div class="routes-list">
            <table class="striped highlight responsive-table">
              <thead>
          <tr>
                  <th>From</th>
                  <th>To</th>
                  <th>Fare</th>
                  <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for route in routes %}
          <tr>
            <td>{{ route.start_area.name }}</td>
            <td>{{ route.end_area.name }}</td>
                  <td>${{ route.cost }}</td>
            <td>
                    <button class="btn-small waves-effect waves-light purple"
                      onclick="previewRoute('{{ route.id }}')">
                      <i class="material-icons left">visibility</i>Preview
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
          </div>
        </div>
      </div>
    </div>
    </div>

  <!-- Map Card -->
  <div class="row">
    <div class="col s12">
      <div class="card" id="map-card">
        <div class="card-content">
          <span class="card-title center-align">Route Map</span>
          <div id="map" style="height: 400px; width: 100%;">
            <div class="center-align" style="padding-top: 180px;">
              <p class="grey-text">Select a route to preview</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
   <!-- Search Bar -->
   <div class="row">
    <div class="col s12">
      <div class="card">
        <div class="card-content">
          <span class="card-title center-align">Search Stops</span>
          <div class="input-field">
            <i class="material-icons prefix">search</i>
            <input type="text" id="stop-search" placeholder="Enter stop name...">
            <label for="stop-search">Search for stops</label>
          </div>
          <div id="search-results" class="collection" style="display: none;"></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Bus Info Modal -->
  <div id="bus-info-modal" class="modal">
    <div class="modal-content">
      <h4>Bus Information</h4>
      <div id="bus-info-content">
        <div class="preloader-wrapper small active">
          <div class="spinner-layer spinner-purple-only">
            <div class="circle-clipper left">
              <div class="circle"></div>
            </div>
            <div class="gap-patch">
              <div class="circle"></div>
            </div>
            <div class="circle-clipper right">
              <div class="circle"></div>
            </div>
          </div>
        </div>
        <p>Loading bus information...</p>
      </div>
    </div>
    <div class="modal-footer">
      <a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a>
    </div>
  </div>
</div>
{% endblock %}

{# ── Extra scripts ────────────────────────────────────────── #}
{% block scripts %}
  {{ super() }}
  <!-- OpenRouteService Maps -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  
  <script>
    let map;
    let routeLayer;
    let markersLayer;
    let currentRouteId = null;
    let stopMarkers = {};
    
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize map
      map = L.map('map').setView([10.6572, -61.5180], 10); // Center on Port of Spain
      
      // Add OpenStreetMap tile layer
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);
      
      // Create layers for the route and markers
      routeLayer = L.layerGroup().addTo(map);
      markersLayer = L.layerGroup().addTo(map);
      
      // Initialize modals
      var elems = document.querySelectorAll('.modal');
      var instances = M.Modal.init(elems);
      
      // Initialize search functionality
      initializeSearch();
      
      // Check OpenRouteService API status
      checkOrsApiStatus();
      
      // Check URL parameters for route_id and scroll_to_map
      const urlParams = new URLSearchParams(window.location.search);
      const routeId = urlParams.get('route_id');
      const scrollToMap = urlParams.get('scroll_to_map');
      
      if (routeId) {
        // Scroll to map first if requested
        if (scrollToMap === 'true') {
          document.getElementById('map-card').scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
        }
        
        // Preview the route from URL parameter after a short delay
        setTimeout(() => {
          previewRoute(routeId);
        }, 300);
      }
    });
    
    /* Initialize stop search functionality */
    function initializeSearch() {
      const searchInput = document.getElementById('stop-search');
      const searchResults = document.getElementById('search-results');
      
      // Add event listener for input changes
      searchInput.addEventListener('input', debounce(function() {
        const query = searchInput.value.trim();
        
        if (query.length < 2) {
          searchResults.style.display = 'none';
          return;
        }
        
        // Fetch search results
        fetch(`/api/stops/search?q=${encodeURIComponent(query)}`)
          .then(response => response.json())
          .then(data => {
            searchResults.innerHTML = '';
            
            if (data.length === 0) {
              searchResults.innerHTML = '<div class="collection-item">No stops found</div>';
            } else {
              data.forEach(stop => {
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'collection-item';
                item.innerHTML = `
                  <span class="title">${stop.name}</span>
                  <p>${stop.type}</p>
                `;
                
                item.addEventListener('click', function(e) {
                  e.preventDefault();
                  
                  // Clear search
                  searchInput.value = '';
                  searchResults.style.display = 'none';
                  
                  // Scroll to map first
                  document.getElementById('map-card').scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                  });
                  
                  // Wait a moment then center map on selected stop
                  setTimeout(() => {
                    // Center map on selected stop
                    map.setView([stop.lat, stop.lng], 15);
                    
                    // Add marker for the stop
                    markersLayer.clearLayers();
                    const marker = L.marker([stop.lat, stop.lng])
                      .bindPopup(`<b>${stop.name}</b><br>${stop.type}`)
                      .addTo(markersLayer);
                    
                    marker.openPopup();
                  }, 300);
                });
                
                searchResults.appendChild(item);
              });
            }
            
            searchResults.style.display = 'block';
          })
          .catch(error => {
            console.error('Error searching stops:', error);
            searchResults.innerHTML = '<div class="collection-item">Error searching stops</div>';
            searchResults.style.display = 'block';
          });
      }, 300));
      
      // Hide search results when clicking outside
      document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
          searchResults.style.display = 'none';
        }
      });
    }
    
    /* Preview the selected route on the map using OpenRouteService for realistic paths */
    function previewRoute(routeId) {
      currentRouteId = routeId;
      
      // Scroll to the map section first
      document.getElementById('map-card').scrollIntoView({
        behavior: 'smooth',
        block: 'start'
      });
      
      // Clear previous layers
      routeLayer.clearLayers();
      markersLayer.clearLayers();
      stopMarkers = {};
      
      // First, get the route stops
      fetch(`/api/routes/${routeId}`)
        .then(response => response.json())
        .then(data => {
          if (data.stops && data.stops.length > 0) {
            // Add markers for each stop
            data.stops.forEach(stop => {
              const marker = L.marker([stop.location.lat, stop.location.lng])
                .bindPopup(createStopPopup(stop))
                .addTo(markersLayer);
              
              // Store marker reference
              stopMarkers[stop.id] = marker;
            });
            
            // Now get realistic route directions
            fetch(`/api/route-directions/${routeId}`)
              .then(response => response.json())
              .then(directions => {
                if (directions.error) {
                  console.warn('Error occured retrieving route lines:', directions.error);
                  // Fallback to straight lines if API fails
                  // const markers = data.stops.map(stop => [stop.location.lat, stop.location.lng]);
                  // const polyline = L.polyline(markers, {color: 'purple', weight: 4}).addTo(routeLayer);
                  // map.fitBounds(polyline.getBounds());
                } else {
                  // Add the GeoJSON route to the map
                  const route = L.geoJSON(directions, {
                    style: {
                      color: 'purple',
                      weight: 4,
                      opacity: 0.7
                    }
                  }).addTo(routeLayer);
                  
                  map.fitBounds(route.getBounds());
                }
              })
              .catch(error => {
                console.error('Error fetching route directions:', error);
                // Fallback to straight lines
                // const markers = data.stops.map(stop => [stop.location.lat, stop.location.lng]);
                // const polyline = L.polyline(markers, {color: 'purple', weight: 4}).addTo(routeLayer);
                // map.fitBounds(polyline.getBounds());
              });
          }
        })
        .catch(error => {
          console.error('Error fetching route data:', error);
          M.toast({html: 'Error loading route preview'});
        });
    }
    
    /* Create popup content for a stop */
    function createStopPopup(stop) {
      return `
        <div class="stop-popup">
          <h6>${stop.location.name}</h6>
          <p>Stop #${stop.stop_index + 1}</p>
          <p>${stop.location.type}</p>
          <button class="btn-small waves-effect waves-light purple" 
            onclick="loadBusInfo(${stop.id}, ${currentRouteId})">
            Show Buses
          </button>
        </div>
      `;
    }
    
    /* Load bus information for a stop */
    function loadBusInfo(stopId, routeId) {
      // Open the modal
      const modal = M.Modal.getInstance(document.getElementById('bus-info-modal'));
      modal.open();
      
      // Set loading state
      document.getElementById('bus-info-content').innerHTML = `
        <div class="center-align" style="margin: 20px 0;">
          <div class="preloader-wrapper small active">
            <div class="spinner-layer spinner-purple-only">
              <div class="circle-clipper left">
                <div class="circle"></div>
              </div>
              <div class="gap-patch">
                <div class="circle"></div>
              </div>
              <div class="circle-clipper right">
                <div class="circle"></div>
              </div>
            </div>
          </div>
          <p>Loading bus information...</p>
        </div>
      `;
      
      // Fetch bus information
      fetch(`/api/stop/${stopId}/buses?route_id=${routeId}`)
        .then(response => response.json())
        .then(data => {
          let content = '';
          
          if (data.error) {
            content = `<p class="red-text">Error: ${data.error}</p>`;
          } else if (data.length === 0) {
            content = '<p>No buses currently approaching this stop.</p>';
          } else {
            content = `
              <table class="striped">
                <thead>
                  <tr>
                    <th>Bus</th>
                    <th>ETA</th>
                    <th>Distance</th>
                    <th>Available Seats</th>
                  </tr>
                </thead>
                <tbody>
            `;
            
            data.forEach(bus => {
              // Format distance
              const distance = bus.distance < 1000 
                ? `${Math.round(bus.distance)}m` 
                : `${(bus.distance / 1000).toFixed(1)}km`;
              
              // Format duration
              const minutes = Math.floor(bus.duration_seconds / 60);
              const seconds = Math.round(bus.duration_seconds % 60);
              const duration = `${minutes}m ${seconds}s`;
              
              content += `
                <tr>
                  <td>${bus.plate_num}</td>
                  <td>${bus.estimated_arrival}</td>
                  <td>${distance} (${duration})</td>
                  <td>${bus.available_seats}</td>
                </tr>
              `;
            });
            
            content += '</tbody></table>';
          }
          
          document.getElementById('bus-info-content').innerHTML = content;
        })
        .catch(error => {
          console.error('Error fetching bus information:', error);
          document.getElementById('bus-info-content').innerHTML = `
            <p class="red-text">Error loading bus information. Please try again.</p>
          `;
        });
    }
    
    /* Debounce function to limit API calls */
    function debounce(func, wait) {
      let timeout;
      return function() {
        const context = this;
        const args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          func.apply(context, args);
        }, wait);
      };
    }
    
    /* Check OpenRouteService API status */
    function checkOrsApiStatus() {
      fetch('/api/ors-status')
        .then(response => response.json())
        .then(data => {
          if (!data.valid) {
            console.warn('OpenRouteService API key issue:', data.message);
            M.toast({
              html: '<i class="material-icons left">warning</i> Using fallback route display. OpenRouteService API key issue.',
              classes: 'orange',
              displayLength: 5000
            });
          }
        })
        .catch(error => {
          console.error('Error checking OpenRouteService API status:', error);
        });
    }
  </script>
{% endblock %}
